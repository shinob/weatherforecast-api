# 地図で見る天気予報アプリ

地図上の任意の地点をクリックすると、その地点の24時間天気予報を表示するWebアプリケーションです。

## 機能

- 📍 **インタラクティブな地図表示**
  - OpenStreetMapを使用した地図表示
  - 日本全国どこでもクリックして天気予報を取得

- 🌤️ **24時間天気予報**
  - 1時間ごとの詳細な気象情報
  - 気温、降水量、風速、風向、湿度、雲量、気圧

- 📊 **視覚的なグラフ表示**
  - 気温推移グラフ
  - 降水量グラフ
  - 風速グラフ

- ⚙️ **操作性の改善**
  - 現在地を使った予報取得
  - 同じ地点の最新データ再取得
  - 表示時間（24/48/72時間）の切替
  - 表示中データのCSVダウンロード
  - 最低/最高気温などのサマリー表示

- 🎨 **レスポンシブデザイン**
  - PC、タブレット、スマートフォンに対応

## 表示される気象データ

| データ項目 | 単位 | 説明 |
|-----------|------|------|
| 気温 (TMP) | °C | 気温 |
| 降水量 (APCP) | mm | 1時間あたりの降水量 |
| 風速 (WSPD) | m/s | 風の速度 |
| 風向 (WDIR) | 度/方位 | 風の方向（16方位表示） |
| 湿度 (RH) | % | 相対湿度 |
| 雲量 (TCDC) | % | 全雲量 |
| 気圧 (PRES) | hPa | 気圧 |

## セットアップ

### 1. ファイル構成

```
weatherforecast-api/
├── index.html        # メインHTML
├── style.css         # スタイルシート
├── config.js         # 設定ファイル（APIトークン）
├── app.js            # JavaScriptメインファイル
├── server-proxy.py   # CORS対応プロキシサーバー（推奨）
├── server-ipv6.py    # IPv6対応シンプルサーバー
└── README.md         # このファイル
```

### 2. APIトークンの設定

`config.js` ファイルを開き、APIトークンを設定してください：

```javascript
const CONFIG = {
    API_TOKEN: 'your_api_token_here',  // ← ここにAPIトークンを入力
    // ...
};
```

デフォルトでは `'api_sample'` が設定されており、サンプルデータを取得できます。
本番環境では必ず有効なAPIトークンに変更してください。

### 3. アプリケーションの起動

#### 推奨方法: CORS対応プロキシサーバー（必須）

天気予報APIは**CORS（Cross-Origin Resource Sharing）制限**があるため、専用のプロキシサーバーを使用する必要があります。

```bash
python3 server-proxy.py 8000
```

このサーバーは以下の機能を提供します：
- 天気予報APIへのプロキシリクエスト
- CORSヘッダーの自動追加
- IPv4/IPv6両対応
- 静的ファイル（HTML/CSS/JS）の配信

起動後、ブラウザで以下のURLにアクセス：
- `http://localhost:8000`
- `http://127.0.0.1:8000`
- `http://[::1]:8000` (IPv6)

#### その他の方法

以下の方法も利用可能ですが、**CORS問題により天気予報の取得が失敗します**。
開発時のUI確認には使用できますが、実際の天気予報機能を使うには上記のプロキシサーバーが必要です。

#### 方法2: Pythonのシンプルサーバー

Pythonがインストールされている場合：

**IPv4/IPv6両対応（推奨）:**

```bash
python3 server-ipv6.py 8000
```

このスクリプトを使用すると、IPv4とIPv6の両方でアクセスできます。
起動時に利用可能なアクセスURLが表示されます。

**アクセス方法:**
- IPv4: `http://localhost:8000` または `http://127.0.0.1:8000`
- IPv6ローカル: `http://[::1]:8000`
- IPv6グローバル: `http://[あなたのIPv6アドレス]:8000`

**標準のPythonサーバー（IPv4のみ）:**

```bash
# Python 3.x
python -m http.server 8000

# Python 2.x
python -m SimpleHTTPServer 8000
```

ブラウザで `http://localhost:8000` にアクセスします。

#### 方法3: Node.jsのhttp-server

Node.jsがインストールされている場合：

```bash
# http-serverをインストール（初回のみ）
npm install -g http-server

# サーバーを起動
http-server -p 8000
```

ブラウザで `http://localhost:8000` にアクセスします。

#### 方法4: VS Code Live Server拡張機能

1. VS Codeで「Live Server」拡張機能をインストール
2. `index.html` を右クリック
3. 「Open with Live Server」を選択

## 使い方

1. アプリケーションを開くと、日本地図が中心に表示されます
2. 地図上の任意の地点をクリックします
3. クリックした地点にマーカーが表示され、天気予報の取得が開始されます
4. 右側のエリアに24時間分の予報が表示されます
   - 上部: 1時間ごとの詳細情報カード
   - 下部: 気温、降水量、風速のグラフ
5. 別の地点をクリックすると、その地点の予報に切り替わります
6. 「現在地を使う」で現在地の予報を取得できます
7. 「表示時間」で24/48/72時間に切り替えられます（再通信不要）
8. 「CSVダウンロード」で表示中の予報データを保存できます

## 技術スタック

- **HTML5/CSS3**: UI構造とスタイリング
- **JavaScript (ES6+)**: アプリケーションロジック
- **Leaflet.js**: 地図表示ライブラリ
- **Chart.js**: グラフ描画ライブラリ
- **ITtools Weather Service API**: 気象予報データ提供

## API仕様

### エンドポイント

```
GET https://weather.ittools.biz/api/forecast/GSM/{token}/{lat},{lng}
```

### パラメータ

- `{token}`: APIトークン
- `{lat}`: 緯度（小数点形式）
- `{lng}`: 経度（小数点形式）

### レスポンス例

```json
{
  "code": 200,
  "result": {
    "latlng": "35.4681908,133.0484055",
    "grib2file_time": "20260225000000",
    "forecast": [
      {
        "datetime": "2026-02-25 17:00:00",
        "PRES": 1008.8,
        "UGRD": -2.39,
        "VGRD": -2.44,
        "TMP": 9.13,
        "RH": 88.2,
        "TCDC": 100.0,
        "APCP": 0.594,
        "DSWRF": 30.2,
        "WSPD": 3.42,
        "WDIR": 45
      }
      // ... 172時間分のデータ
    ]
  }
}
```

## カスタマイズ

### 表示時間数の変更

`config.js` の `FORECAST_HOURS` を変更すると、表示する予報時間数を調整できます：

```javascript
FORECAST_HOURS: 48  // 48時間表示に変更
```

### デフォルト地図位置の変更

`config.js` の `DEFAULT_MAP_CENTER` と `DEFAULT_ZOOM` を変更：

```javascript
DEFAULT_MAP_CENTER: [35.6762, 139.6503],  // 東京
DEFAULT_ZOOM: 10
```

### 天気アイコンのカスタマイズ

`app.js` の `getWeatherIcon()` 関数を編集して、独自のアイコンを設定できます。

## IPv6での利用について

このアプリケーションはIPv6環境でも利用できます。

### IPv6対応サーバーの起動

専用のIPv6対応サーバースクリプトを用意しています：

```bash
python3 server-ipv6.py 8000
```

### IPv6アドレスでのアクセス

ブラウザでIPv6アドレスにアクセスする際は、アドレスを角括弧 `[ ]` で囲む必要があります：

```
http://[::1]:8000                                # ローカルホスト
http://[2001:db8::1]:8000                        # グローバルIPv6（例）
http://[fe80::1234:5678:9abc:def0%eth0]:8000    # リンクローカル（要インターフェース名）
```

### 注意事項

- ブラウザによってはIPv6のサポート状況が異なります
- リンクローカルアドレス（fe80::）を使用する場合は、ネットワークインターフェース名（例: `%eth0`）の指定が必要です
- ファイアウォールでIPv6のポートが開放されているか確認してください

## トラブルシューティング

### APIエラーが発生する

- `config.js` のAPIトークンが正しく設定されているか確認
- インターネット接続を確認
- ブラウザの開発者ツール（F12）でネットワークタブを確認

### 地図が表示されない

- インターネット接続を確認（Leaflet.jsとOpenStreetMapはCDNから読み込まれます）
- ブラウザのコンソールエラーを確認

### グラフが表示されない

- Chart.jsがCDNから正しく読み込まれているか確認
- ブラウザのコンソールエラーを確認

### CORSエラーが発生する

- ローカルサーバー（Python、Node.js、Live Serverなど）を使用して実行してください
- `file://` プロトコルでは一部の機能が動作しない場合があります

### IPv6で接続できない

- システムでIPv6が有効化されているか確認: `ip -6 addr show`
- `server-ipv6.py` を使用しているか確認
- ファイアウォールでIPv6ポートが許可されているか確認
- ブラウザがIPv6をサポートしているか確認

## ライセンス

このプロジェクトはMITライセンスのもとで公開されています。

## 謝辞

- [ITtools Weather Service](https://weather.ittools.biz/) - 気象予報データAPI
- [Leaflet](https://leafletjs.com/) - 地図ライブラリ
- [Chart.js](https://www.chartjs.org/) - グラフライブラリ
- [OpenStreetMap](https://www.openstreetmap.org/) - 地図データ

## サポート

問題が発生した場合は、ブラウザの開発者ツール（F12キー）でコンソールログを確認してください。
